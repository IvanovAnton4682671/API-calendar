# API-сервис производственного календаря

## Описание проекта

***API-calendar** - это веб-сервис, который позволяет добавлять, изменять и получать данные производственного календаря. Сервис реализован как **RESTful API** с использованием стандартных HTTP-методов. Возвращает ответы в формате json*

## Технологический стек

| ***Раздел***                   | ***Технологии***                                                                                                                 |
| ------------------------------ | -------------------------------------------------------------------------------------------------------------------------------- |
| **Инфраструктура**             | **Docker Compose (оркестрация)<br>PostgreSQL (основная СУБД)**                                                                   |
| **Бэкенд**                     | **Python (язык бэкенда)<br>FastAPI (веб-фреймворк)<br>SQLAlchemy (ORM)<br>Pydantic (валидация данных)<br>Uvicorn (ASGI-сервер)** |
| **Вспомогательные библиотеки** | **Httpx (HTTP-слиент)<br>Bs4 (парсинг HTML)<br>Pydantic Settings (управление конфигурацией)**                                    |

## Структура проекта

###### Инициализация БД
`/db/init.sql` - создание пользователя, БД, выдача прав на Бд пользователю

###### Конфигурация
`/server/core/config.py` - работа с переменными окружения
`/server/core/consts.py` - глобальные константы
`/server/core/logger.py` - настройка логгера, печатает логи в stdout

###### Работа с БД
`/server/database.py` - настройка работы с асинхронными сессиями

###### Модель данных
`/server/model.py` - модель таблицы БД

###### Схемы валидации
`/server/schemas.py` - схемы валидации данных для разных сущностей

###### Репозиторий
`/server/repo.py` - CRUD-логика работы с БД

###### Сервисы
`/server/services/calendar_day.py` - логика работы с собственным календарём
`/server/services/calendar_day_utils.py` - вспомогательные функции для работы с собственным календарём
`/server/services/external.py` - логика работы с внешними ресурсами
`/server/services/external_utils.py` - вспомогательные функции для работы с внешними ресурсами

###### Роутер
`/server/router.py` - главный роутер, описывает все эндпоинты

###### Запуск
`docker-compose.yml` - запуск и управление контейнерами
`server/main.py` - точка входа в сервер

## Методы

###### GET /period/{period}
Получает данные производственного календаря по периоду:

| Интервал            | Шаблон                | Пример                |
| ------------------- | --------------------- | --------------------- |
| Год                 | ГГГГ                  | 2025                  |
| Квартал             | QNГГГГ                | Q12025                |
| Месяц               | ММ.ГГГГ               | 01.2025               |
| Сутки               | ДД.ММ.ГГГГ            | 01.01.2025            |
| Произвольный период | ДД.ММ.ГГГГ-ДД.ММ.ГГГГ | 01.01.2025-10.01.2025 |
Опциональные `Query`-параметры:
- **compact (bool)**: по умолчанию значение `False`; если задать значение `True`, то данные будут выдаваться в сокращённом формате (только особые дни, которые отличаются от обычного календаря. Например: есть `note`, `type_id = 3`, `type_id = 2` в среду)
- **week_type (int)**: означает тип рабочей недели (`5`- или `6`-дневная); по умолчанию значение `5`, можно задать `6`
- **statistic (bool)**: по умолчанию значение `False`; если задать значение `True`, то будет выдавать дополнительную статистику по запрашиваемому периоду в формате:
```json
{
    "calendar_days": 10,
    "calendar_days_without_holidays": 2,
    "work_days": 2,
    "weekends": 0,
    "holidays": 8
}
```
Возвращает ответ в формате:
```json
{
    "date_start": "01.01.2025",
    "date_end": "10.01.2025",
    "work_week_type": "5-дневная рабочая неделя",
    "period": "Произвольный период",
    "days":
    [
        {
            "date": "01.01.2025",
            "type_id": 3,
            "type_text": "Государственный праздник",
            "note": "Новогодние каникулы",
            "week_day": "ср"
        },
        ...
        {
            "date": "09.01.2025",
            "type_id": 1,
            "type_text": "Рабочий день",
            "week_type": "чт"
        },
        ...
    ]
}
```
В массиве `days` объекты описывают календарные сутки, обладают следующими свойствами:
- **type_id** и **type_text** определяют тип суток:
  
| id  | Описание                 |
| --- | ------------------------ |
| 1   | Рабочий день             |
| 2   | Выходной день            |
| 3   | Государственный праздник |
- **note**: опциональное описание дня
- **week_type**: день недели в сокращённом формате (`пн`, `вт`, `ср`, `чт`, `пт`, `сб`, `вс`)

###### POST /date
Добавляет запись в БД производственного календаря. Принимает данные в `json`-формате:
```json
{
    "date": "2025-03-03",
    "type_id": 1,
    "note": "Необязательная подпись"
}
```

###### PUT /date/{date}
Изменяет запись в БД производственного календаря. Изменяет день `{date}`, получает данные в `json`-формате:
```json
{
    "date": "2025-03-03",
    "type_id": 2,
    "note": "Теперь это выходной"
}
```

###### DELETE /date/{date}
Удаляет запись из БД производственного календаря. Удаляет день `{date}`

###### GET /external/period/{year}
Получает данные производственного календаря за год:

| Шаблон | Пример |
| ------ | ------ |
| ГГГГ   | 2025   |
Опциональные `Query`-параметры:
- **week_type (int)**: аналогично `/period/{period}`
- **statistic (bool)**: аналогично `/period/{period}`
<u>При отправке запроса сервер формирует календарь не сам, а получает его из внешнего источника, и не изменяет данными из своей БД.</u>
Сервер отправляет GET-запрос ресурсу **"Консультант Плюс"** (https://www.consultant.ru), получает HTML-страницу календаря, парсит её и возвращает в формате, аналогичном `/period/{period}`. При неудачном получении ответа от ресурса **"Консультант Плюс"** выполняется аналогичный запрос на резервный ресурс **"HH.ru"** (https://hh.ru)

## Внешние источники данных

Данные производственных календарей для метода `/external/period/{year}` получены из открытых источников:
- **Консультант Плюс** (https://www.consultant.ru)
- **HH.ru** (https://hh.ru)

## Использование

- Склонируйте репозиторий:
```bash
git clone https://github.com/IvanovAnton4682671/API-calendar.git
```
- Перейдите в папку проекта:
```bash
cd API-calendar
```
- В папке `/server` создайте файл `.env` по примеру `.env.example`
- Запустите проект (требуется Docker):
```bash
docker-compose up --build -d
```
- Перейдите по адресу http://localhost:8000/docs
- Пользуйтесь сервисом
- Для остановки проекта:
```bash
docker-compose down      #без удаления данных БД
docker-compose down -v   #с удалением данных БД
```
